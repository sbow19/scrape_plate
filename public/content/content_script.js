(()=>{"use strict";class e{static init(){e._eventEmitter.subscribe("fetch",e._fetchUserContent),e._eventEmitter.subscribe("getAll",e._returnUserContent),e._eventEmitter.subscribe("getAllOf",e._returnAllOf),e._eventEmitter.subscribe("getMatchingSchemas",e._returnMatchingSchemas),e._eventEmitter.subscribe("search",e._returnSearch),e._eventEmitter.subscribe("create",e._createData),e._eventEmitter.subscribe("delete",e._deleteData),e._eventEmitter.subscribe("update",e._updateData),e._eventEmitter.subscribe("set_test_data",e._setTestData)}static async _fetchUserContent(){return new Promise(((t,a)=>{try{const r=s("database",{method:"read",type:"all"});chrome.runtime.sendMessage(r).then((r=>{"database"!==r.operation&&a(r),r.data.success||a(r),e._userContentModel=r.data.payload,t(e._userContentModel)})).catch((e=>{a(e)}))}catch{a({})}}))}static _returnUserContent(){return e._userContentModel}static _returnMatchingSchemas(){return new Promise(((t,a)=>{try{const r=s("database",{method:"read",type:"schemaMatches"});chrome.runtime.sendMessage(r).then((r=>{"database"!==r.operation&&a(r),r.data.success||a(r),e._schemaMatches=r.data.payload,t(e._schemaMatches)})).catch((e=>{a(e)}))}catch{a({})}}))}static _returnAllOf(t){return e._userContentModel[t]}static _returnSearch(t){if(!t||!Object.keys(t).includes("term")||!Object.keys(t).includes("type"))throw new Error("Options require a term property and type property");let a=[],{term:r,type:s}=t;if("string"!=typeof r)throw new TypeError("Term must be a string");switch(r=r.toLowerCase(),s){case"project":return a=Object.values(e._userContentModel.projects).filter((e=>!!e.name.toLowerCase().includes(r.toLowerCase())||e.id===r)),a;case"schema":return a=Object.values(e._userContentModel.schemas).filter((e=>!(!e.name||!e.name.toLowerCase().includes(r.toLowerCase()))||e.id===r)),a;case"capture":{const t=Object.values(e._userContentModel.projects);for(const e of t)Object.values(e.captures).forEach((e=>{(e.name&&e.name.toLowerCase().includes(r.toLowerCase())||e.id===r||e.schema_id===r)&&a.push(e)}));return a}default:return null}}static _returnExactSearch(t){if(!t||!Object.keys(t).includes("term")||!Object.keys(t).includes("type"))throw new Error("Options require a term property and type property");let a=[],{term:r,type:s}=t;if("string"!=typeof r)throw new TypeError("Term must be a string");switch(r=r.toLowerCase(),s){case"project":return a=Object.values(e._userContentModel.projects).filter((e=>e.name.toLowerCase()===r.toLowerCase()||e.id===r)),a;case"schema":return a=Object.values(e._userContentModel.schemas).filter((e=>!(!e.name||e.name.toLowerCase()!==r.toLowerCase())||e.id===r)),a;case"capture":{const t=Object.values(e._userContentModel.projects);for(const e of t)Object.values(e.captures).forEach((e=>{(e.name&&e.name.toLowerCase()===r.toLowerCase()||e.id===r||e.schema_id===r)&&a.push(e)}));return a}default:return null}}static _createData(t){r(t);let a=[];["schema","capture","project"].includes(t.type)&&(a=e._returnExactSearch({type:t.type,term:t.data.name}));const c=s("database",t);let n;const o=(new Date).toISOString(),i=crypto.randomUUID();switch(t.type){case"capture":n="captures",t.data.date_created=o,t.data.last_edited=o,t.data.id=i;break;case"project":n="projects",t.data.date_created=o,t.data.last_edited=o,t.data.id=i;break;case"schema":n="schemas",t.data.id=i}return new Promise(((r,s)=>{if(a.length>0){const e={operation:"database",data:{success:!1,message:`${t.type}: ${t.data.name} already exists.`,payload:null,type:"project",method:"create"}};s(e)}else chrome.runtime.sendMessage(c).then((a=>{a.data.success?("captures"===n?e._userContentModel.projects[t.data.project_id].captures[t.data.id]=t.data:e._userContentModel[n][t.data.id]=t.data,r(a)):a.data.success||s(a)})).catch((e=>s(e)))}))}static _deleteData(t){const a=s("database",t);let r;switch(t.type){case"capture":r="captures";break;case"project":r="projects";break;case"schema":r="schemas";break;case"schemaEntry":r="schemaEntry";break;case"captureRow":r="captureRow"}return new Promise(((s,c)=>{chrome.runtime.sendMessage(a).then((a=>{a.data.success?("captures"===r?delete e._userContentModel.projects[t.data.project_id].captures[t.data.id]:"schemaEntry"===r?delete e._userContentModel.schemas[t.data.schema_id].schema[t.data.id]:"captureRow"===r?delete e._userContentModel.projects[t.data.project_id].captures[t.data.capture_id].capture_body[t.data.id]:delete e._userContentModel[r][t.data],s(a)):a.data.success||c(a)})).catch((e=>{c(e)}))}))}static _updateData(t){r(t);const a=s("database",t),c=(new Date).toISOString();let n;switch(t.type){case"capture":n="captures",t.data.last_edited=c;break;case"project":n="projects",t.data.last_edited=c;break;case"schema":n="schemas";break;default:n=t.type}return new Promise(((r,s)=>{chrome.runtime.sendMessage(a).then((a=>{a.data.success?("captures"===n?e._userContentModel.projects[t.data.project_id].captures[t.data.capture_id]=t.data:"details"===n?e._userContentModel[n]=t.data:e._userContentModel[n][t.data.id]=t.data,r(a)):a.data.success||s(a)})).catch((e=>{s(e)}))}))}static get events(){return e._eventEmitter}static get hasLoaded(){return e._hasLoaded}static set hasLoaded(t){e._hasLoaded=t}static _setTestData(){e._userContentModel=JSON.parse(JSON.stringify(e._testData))}static get testData(){return e._testData}}Object.defineProperty(e,"_eventEmitter",{enumerable:!0,configurable:!0,writable:!0,value:new class{constructor(){Object.defineProperty(this,"_events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._events={}}subscribe(e,t){if(this._events[e])throw Error("Listener already attached");return this._events[e]=t,()=>{delete this._events[e]}}emit(e,t){const a=this._events[e],r=JSON.parse(JSON.stringify(t));return new Promise(((e,t)=>{if(a){let s=null;try{s=a.call(null,r)}catch(e){t(e)}if(!s)return void e(s);"function"==typeof s.then?s.then((t=>{e(t)})).catch((e=>{console.log("Error caught in event emitter",e),t(e)})):e(s)}else e(null)}))}get events(){return this._events}}}),Object.defineProperty(e,"_hasLoaded",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(e,"_testData",{enumerable:!0,configurable:!0,writable:!0,value:{details:{hasUsedOnce:!1,username:"",last_used:"",updateRequired:!0,currentProject:"a11aa111-11aa-1111-a111-1a11a1a1a111"},projects:{"a11aa111-11aa-1111-a111-1a11a1a1a111":{name:"project1",date_created:"2025-01-10T14:30:00",last_edited:"2025-03-13T14:30:00",id:"a11aa111-11aa-1111-a111-1a11a1a1a111",captures:{"c11aa111-11aa-1111-a111-1a11a1a1a111":{id:"c11aa111-11aa-1111-a111-1a11a1a1a111",url_match:"https://",date_created:"2025-01-11T14:30:00",last_edited:"2025-01-12T14:30:00",project_id:"a11aa111-11aa-1111-a111-1a11a1a1a111",schema_id:"s11aa111-11aa-1111-a111-1a11a1a1a111",name:"capture1",capture_body:{location:{key:{match_expression:"id1",match_type:"id",matched_value:"location"},value:{match_expression:"id2",match_type:"id",matched_value:"Hamburg"}},age:{key:{match_expression:null,match_type:"manual",matched_value:"age"},value:{match_expression:"id4",match_type:"id",matched_value:"22"}}}},"c11aa111-11aa-1111-a111-1a11a1a1a112":{id:"c11aa111-11aa-1111-a111-1a11a1a1a112",date_created:"2025-01-11T14:30:00",last_edited:"2025-01-12T14:30:00",schema_id:"s11aa111-11aa-1111-a111-1a11a1a1a112",project_id:"a11aa111-11aa-1111-a111-1a11a1a1a111",name:"capture2",url_match:"https://",capture_body:{id:{key:{match_expression:null,match_type:"manual",matched_value:"id"},value:{match_expression:"id2",match_type:"id",matched_value:"Go"}},name:{key:{match_expression:"id3",match_type:"id",matched_value:"name"},value:{match_expression:"id4",match_type:"id",matched_value:"Is great"}}}}}},"a11aa111-11aa-1111-a111-1a11a1a1a112":{name:"project2",date_created:"2024-01-10T14:30:00",last_edited:"2024-03-13T14:30:00",id:"a11aa111-11aa-1111-a111-1a11a1a1a112",captures:{"c11aa111-11aa-1111-a111-1a11a1a1a113":{id:"c11aa111-11aa-1111-a111-1a11a1a1a113",date_created:"2025-01-11T14:30:00",last_edited:"2025-01-12T14:30:00",project_id:"a11aa111-11aa-1111-a111-1a11a1a1a112",schema_id:"s11aa111-11aa-1111-a111-1a11a1a1a111",url_match:"https://",name:"capture1",capture_body:{location:{key:{match_expression:"id1",match_type:"id",matched_value:"location"},value:{match_expression:"id2",match_type:"id",matched_value:"United Kingdom"}},age:{key:{match_expression:null,match_type:"manual",matched_value:"age"},value:{match_expression:"id4",match_type:"id",matched_value:"74"}}}},"c11aa111-11aa-1111-a111-1a11a1a1a114":{id:"c11aa111-11aa-1111-a111-1a11a1a1a114",date_created:"2025-01-11T14:30:00",last_edited:"2025-01-12T14:30:00",project_id:"a11aa111-11aa-1111-a111-1a11a1a1a112",schema_id:"s11aa111-11aa-1111-a111-1a11a1a1a112",name:"capture2",url_match:"https://",capture_body:{id:{key:{match_expression:null,match_type:"manual",matched_value:"id"},value:{match_expression:"id2",match_type:"id",matched_value:"123456789"}},name:{key:{match_expression:"id3",match_type:"id",matched_value:"name"},value:{match_expression:"id4",match_type:"id",matched_value:"Nicholas Watsowky"}}}}}}},schemas:{"s11aa111-11aa-1111-a111-1a11a1a1a112":{id:"s11aa111-11aa-1111-a111-1a11a1a1a112",name:"schema2",url_match:"https://www.google.com",schema:{id:{key:{match_expression:null,match_type:"manual",matched_value:"id"},value:{match_expression:"id2",match_type:"id",matched_value:null}},name:{key:{match_expression:"id3",match_type:"id",matched_value:"name"},value:{match_expression:"id4",match_type:"id",matched_value:null}}}},"s11aa111-11aa-1111-a111-1a11a1a1a111":{id:"s11aa111-11aa-1111-a111-1a11a1a1a111",name:"schema1",url_match:"https://www.amazon.com",schema:{location:{key:{match_expression:"id1",match_type:"id",matched_value:"location"},value:{match_expression:"id2",match_type:"id",matched_value:null}},age:{key:{match_expression:null,match_type:"manual",matched_value:"age"},value:{match_expression:"id4",match_type:"id",matched_value:null}}}}}}});const t=e;function a(e){const t=["id","css selector","manual","regex "],a=["string","object"];if(!e.id)throw new TypeError("Schema must contain an id");if("object"!=typeof e)throw new TypeError("Schema not an object");const{key:r,value:s}=e;if((r.matched_value?.length??0)>256||!a.includes(typeof r.matched_value))throw new Error("Schema key name invalid - must be a string of 100 characters or less");if((s.matched_value?.length??0)>256||!a.includes(typeof s.matched_value))throw new Error("Schema value invalid - must be a string of 100 characters or less");if(!t.includes(r.match_type))throw new Error("Schema key match type invalid - must be regex, id, or css selector");if(!t.includes(s.match_type))throw new Error("Schema value match type invalid - must be regex, id, or css selector");if((r.match_expression?.length??0)>256||!a.includes(typeof r.match_expression))throw new Error("Schema key match expression invalid - must be a string of 256 characters or less");if((s.match_expression?.length??0)>256||!a.includes(typeof s.match_expression))throw new Error("Schema value match expression invalid - must be a string of 256 characters or less")}function r(e){const r=["method","data","type"];for(const t of Object.keys(e))if(!r.includes(t))throw new TypeError("CRUD options have incorrect keys");const{type:s,method:c,data:n}=e;if("string"!=typeof s||!["project","schema","capture","details","captureRow"].includes(s))throw new TypeError("CRUD operation data type value incorrect");if("string"!=typeof c||!["create","update","read","delete"].includes(c))throw new TypeError("CRUD operation method value incorrect");!function(e,r){switch(e){case"project":{const e=["name","last_edited","date_created","id","captures"];for(const t of Object.keys(r))if(!e.includes(t))throw new TypeError(`ProjectGroup object does not contain ${t} key`);for(const[e,t]of Object.entries(r))switch(e){case"name":if("string"!=typeof t)throw new TypeError("Project name not a string");if(t.length>20)throw new Error("Project name must be less than 20 characters");break;case"last_edited":if("string"!=typeof t)throw new TypeError("Project last edited not a string");break;case"date_created":if("string"!=typeof t)throw new TypeError("Project created data not a string");break;case"id":if("string"!=typeof t)throw new TypeError("Project id not a string");break;case"captures":if("object"!=typeof t)throw new TypeError("captures not an object")}}break;case"capture":{const e=["name","last_edited","date_created","project_id","id","capture_body","schema_id","url_match"];for(const t of Object.keys(r))if(!e.includes(t))throw new TypeError(`Capture object does not contain ${t} key`);for(const[e,s]of Object.entries(r))switch(e){case"name":if("string"!=typeof s)throw new TypeError("Capture  name not a string");if(s.length>20)throw new Error("Capture name must be less than 20 characters");break;case"last_edited":if("string"!=typeof s)throw new TypeError("Capture  last edited not a string");break;case"date_created":if("string"!=typeof s)throw new TypeError("Capture  created data not a string");break;case"id":if("string"!=typeof s)throw new TypeError("Capture id not a string");break;case"url_match":if("string"!=typeof s)throw new TypeError("Capture url match not a string");break;case"capture_body":Object.values(s).forEach((e=>{a(e)}));break;case"schema_id":if("string"!=typeof s)throw new TypeError("captures schema_id not an string");if(!Object.keys(t._userContentModel.schemas).includes(s))throw new Error("Capture schema id does not exist");break;case"project_id":if("string"!=typeof s)throw new TypeError("captures project_id not an string");if(!Object.values(t._userContentModel.projects).flat().find((e=>{if(e.id===s)return!0})))throw new Error("Capture project id does not exist")}}break;case"schema":{const e=["name","id","url_match","schema"];for(const t of Object.keys(r))if(!e.includes(t))throw new TypeError(`Schema object does not contain ${t} key`);for(const[e,t]of Object.entries(r))switch(e){case"name":if("string"!=typeof t&&null!==t)throw new TypeError("Schema  name not a string or null value");if(t.length>20)throw new Error("Schema name must be less than 20 characters");break;case"id":if("string"!=typeof t)throw new TypeError("Schema id not a string");break;case"schema":Object.values(t).forEach((e=>{a(e)}));break;case"url_match":if("string"!=typeof t)throw new TypeError("Schema url match not a string")}}}}(s,n)}function s(e,t){switch(e){case"database":if(!t)throw new Error("CRUD Options data required for db operation");return{operation:e,data:t};case"openSidePanel":if(!t)throw new Error("OpenSidePanelOptions required to open side panel");return{operation:e,data:t};case"getCurrentTab":return{operation:e,data:""};case"sendDOMData":if(!t)throw new Error("DOM Data required to send DOM Message");return{operation:"sendDOMData",data:t};case"otherOperation":return{operation:e,data:{otherField:"",success:!1}};default:throw new TypeError("Message operation type incorrect - e.g. database")}}{function c(e){if(!e)return;const t=e?.firstChild?.cloneNode(),a=e?.parentElement;t&&a&&a.replaceChild(t,e),h=null}function n(e){const t=e.parentElement;let a=document.createElement("span");a.className="scrape_plate_hover",a.style.backgroundColor="yellow";const r=e.cloneNode(!1);a.appendChild(r),t?.replaceChild(a,e),h=a}function o(e){return e.filter((e=>8!==e.nodeType&&"HR"!==(e?.tagName??"")&&"BR"!==(e?.tagName??"")))}function i(e,t){return o(Array.from(e.childNodes))[t]}function d(e){let t=e;const a=t.lastIndexOf("child:"),r=t.slice(a+6);return t=t.slice(0,a),[t,Number(r)]}function l(e){const t=e.split(";");let a=document.querySelector("html");for(let e=0;e<t.length;e++){if(!a||"string"==typeof a)return a;let[,r]=d(t[e]);a=i(a,r)}return a}let u,h=null;function m({clientX:e,clientY:t}){const a=document.elementFromPoint(e,t);if(null===a)return!1;if(a===h)return;const r=a.childNodes;for(let a of r){if(a===h)return;if(3===a.nodeType){const r=document.createRange();r.selectNode(a);const s=r.getClientRects();for(let r of s)if(e>r.left&&e<r.right&&t>r.top&&t<r.bottom)return c(h),void n(a)}}c(h)}function p(e){let t,a,r="",s=e,c=0;for(;t=s.parentElement,t;){a=o(Array.from(t.childNodes)).indexOf(s);let e="";if(e+=t.tagName.toLowerCase(),t.id&&0===c){const e=i(document.getElementById(t.id),a);return{matchType:"id",matchExpression:t.id,matchValue:e?.textContent??""}}if(t.id)e+=`#${t.id}`;else if(t.classList.length>0)for(let a of t.classList)e+=`.${a}`;e+=` child:${a};`,r=e+(r?" > "+r:""),s=t,c++}const n=l(r);return{matchType:"css selector",matchExpression:r,matchValue:n?.textContent??""}}function _(e){e.preventDefault();const t=document.elementFromPoint(e.clientX,e.clientY);if(null===t)return!1;if(t===h){const e=s("sendDOMData",{type:"fetchOne",data:p(h)});return void u.postMessage(e)}const a=t.childNodes;for(let e of a)if(e===h){const e=s("sendDOMData",{type:"fetchOne",data:p(h)});return void u.postMessage(e)}}chrome.runtime.onConnect.addListener((e=>{u=e,y.style.backgroundColor="rgba(0,0,0,0.25)",document.addEventListener("mousemove",m),document.addEventListener("click",_),u.onDisconnect.addListener((e=>{y.style.backgroundColor="rgba(0,0,0,0)",document.removeEventListener("mousemove",m),document.removeEventListener("mousemove",_)})),u.onMessage.addListener((e=>{if("sendDOMData"===e.operation)if("fetchMany"===e.data.type){const t=e.data.data.schema;Object.values(t).forEach((e=>{const a=t[e.id].value;if(a.match_expression)if("id"===a.match_type){const r=document.getElementById(a.match_expression);t[e.id].value.matched_value=r?.textContent?.trim()??""}else if("css selector"===a.match_type){const r=l(a.match_expression);t[e.id].value.matched_value=r?.textContent?.trim()??""}}));const a=s("sendDOMData",{data:t,type:"fetchMany"});u.postMessage(a)}else if("fetchOne"===e.data.type){const t=e.data.data;if("id"===t.matchType){const e=document.getElementById(t.matchExpression);t.matchValue=e?.textContent?.trim()??""}else if("css selector"===t.matchType){const e=l(t.matchExpression);t.matchValue=e?.textContent?.trim()??""}const a=s("sendDOMData",{data:t,type:"fetchOne"});u.postMessage(a)}}))}));const y=document.createElement("div");y.style.position="fixed",y.style.width="100vw",y.style.height="100vh",y.style.backgroundColor="rgba(0,0,0,0)",y.style.pointerEvents="none",y.style.zIndex="10000",y.style.top="0",y.style.left="0",y.id="scrape_plate_overlay",document.body.appendChild(y)}})();